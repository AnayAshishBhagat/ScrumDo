{% extends "projects/base.html" %}

{% load i18n %}
{% load uni_form %}
{% load avatar_tags %}
{% load threadedcommentstags %}
{% load pagination_tags %}
{% load extra_tagging_tags %}
{% load projects_tags %}
{% load iteration_tags %}
{% load group_tags %}
{% load topics_tags %}
{% load wiki_tags %}
{% load theme_tags %}
{% load iteration_tags %}
{% load story_tags %}

{% block head_title %}{{ project.name }}{% endblock %}

{% block breadcrumbs %}
  {% if project.organization %}
     <a href="{% url organization_detail project.organization.slug %}">{{ project.organization.name }}</a> /
  {% else %}
    {{ project.creator.username }} /
  {% endif %}  
  <a href="{% url project_detail project.slug %}">{{ project.name }}</a> /
  {{ iteration.name }}
{% endblock %}


{% block add_story %}
    {% if user.is_authenticated %}
    {% canwrite project %}
    <script>
    	$(function() {    
			$( "#form-tabs" ).tabs();		
			{% if show_epic %}
			  $("#form-tabs").tabs('select', 1);
			{% endif %}
    	});
	</script>
    <div id="form-tabs">
        <ul>
    		<li><a href="#tabs-1">Story</a></li>
    		<li><a href="#tabs-2">Epic</a></li>
    	</ul>
      <div id="tabs-1">{% include "stories/add_story_form.html" %}</div>
      <div id="tabs-2">{% include "stories/add_epic_form.html" %}</div>
    </div>
    {% endcanwrite %}

    {% endif %}
{% endblock %}


{% block body %}
            
        <div style="clear:both;">&nbsp;</div>

        <img style="float:right" src="{{ STATIC_URL }}images/ajax-loader.gif" id="loadingIcon">
        

		<h1>Stories</h1>
		
        {% with iteration.id as iteration_id %}
			{% with 1 as backlog_mode %}
              {% include "stories/filter_form.html" %}
			{% endwith %}
        {% endwith %}         
       
        <ul id="story_list" style="min-height:20px">

        </ul>
    


		<div id="size-options" style="float:right">
		<input type="radio" id="small_epics" name="radio" /><label for="small_epics">_</label>
		<input type="radio" id="med_epics" name="radio" /><label for="med_epics">=</label>
		<input type="radio" id="big_epics" name="radio" checked="checked"  /><label for="big_epics">â‰¡</label>
		</div>
				<h1>Epics</h1>
		<ul id="epic_list">
			{% for epic in iteration.epics.all %}
				<li class="epic_story_list" id="epic_{{epic.id}}">	
					<div class="epic_block">						
						
						
						{% if epic.points_value %}
						<div class="pointsBox epicPointsBox">{{ epic|show_points }}</div>
						{% endif %}
						
						<div class="epic_gripper"></div>
						<h3 class="epic_header"><!-- <span class="on_active"><img src="{{STATIC_URL}}images/downTriangle.png"></span>
																		<span class="on_inactive"><img src="{{STATIC_URL}}images/rightTriangle.png"></span>  -->
												#E{{epic.local_id}} {{epic.summary}}  
						</h3>
						
						<span class="epic_detail">{{epic.detail}}</span>
						<div class="epic_list_holder">
							<ul class="epic_story_list_item" epic_id="{{epic.id}}" id="epic_{{epic.id}}_list">
								{% for story in epic.stories_by_order %}
								   {% ifequal story.iteration.id iteration.id %}
									  {% include "stories/single_block_story.html" %}
								   {% else %}
								     <div style="opacity:0.5">
 									   Scheduled for {{ story.iteration.name }}:
								       {% include "stories/single_block_story.html" %}								       
								     </div>
  								   {% endifequal %}
								{% endfor %}
							</ul>
						</div>
					</div>
				</li>
			{% endfor %}
		</ul>
    

      <div id="subIterationList" style="display:none">
        {% for subiteration in project.iterations.all %}
          {% ifnotequal subiteration iteration %}
          
            <div class="subIteration" iteration_id="{{subiteration.id}}">{% iteration_icon subiteration %} {{subiteration.name}}</div>
          {% endifnotequal %}
        {% endfor %}
      </div>

    
      <div id="iterationDetails" style="display:none; width:600px;">
        <h2>Iteration Details</h2>
        <form method="POST" class="uniForm" action="" style="width:600px;">
          <fieldset class="inlineLabels">
           {{ iteration_form|as_uni_form }}
           <div class="form_block">
               <div class="buttonHolder">
                  <button class="primaryAction" type="submit" >Save</button>
               </div
           </div>
           </fieldset>
         </form>
      </div>
      
      
    <div id="deleteIteration" style="display: none">
      <form method="POST" id="deleteForm" action="{% url delete_iteration project.slug iteration.id %}">
    	<strong>Are you sure you want to delete this iteration?</strong>
    	<input type="submit" style="display: inline; " value="Yes" />
    	<button><a style="text-decoration: none; color: #000" href="{% url iteration project.slug iteration.id %}">No</a></button>
    	<br/>
      </form>
      <p>Note: Iterations can only be deleted when they contain no stories.</p>
    </div>
    


    
    
{% endblock %}

{% block extra_body %}

<script type="text/javascript">
var project_slug = "{{ iteration.project.slug }}";
var current_story_popup = "";
var last_load_iter_req = null;
var static_url = "{{ STATIC_URL }}";
var iteration_id = "{{ iteration.id }}";
var iteration_list_url = "{% url iteration_list project.slug %}";
var iteration_stats_url = "{% url iteration_stats project.slug iteration.id %}";
</script>

<script type="text/javascript" src="{{STATIC_URL}}js/jquery.cookie.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.collapse.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/iteration.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/backlog.js"></script>

<script type="text/javascript">
$(document).ready(function(){
	// $("#story_list").sortable({
	//         update: updateStoryPosition,
	//         tolerance: 'pointer',
	//         distance: 5,
	//         opacity: 0.6,
	//         placeholder: "ui-state-highlight",
	//         cancel: ".block_story_body"
	//     });

	loadIteration(iteration_id, 1, "backlog_mode=true");
	
	$("#epic_list").sortable({
		tolerance: 'pointer',
        distance: 5,
		placeholder: "ui-state-highlight",
	});
	
	$(".epic_story_list_item, #story_list").sortable({
        stop: updateBacklogStoryPosition,
        tolerance: 'intersect',
        distance: 5,
		dropOnEmpty: true,
        opacity: 0.5,
		greedy: true,
        placeholder: "ui-state-highlight",
        cancel: ".block_story_body",
		connectWith: ".epic_story_list_item, #story_list, .epic_block"
    });

	// $('.epic_block').droppable(
	// {
	//   accept: '.epic_story_list_item li, #story_list li',
	//   drop: function(event, ui)
	//   {
	//     ui.draggable.clone().attr("style", "").appendTo( $(this).find("ul") );
	//     ui.draggable.remove();
	//   }
	// });
	// 
	// $(".epic_block").collapse({
	// 	head:"h4",
	// 	group:".epic_story_list_item",
	// 	show: function() {
	//         this.animate({
	//             opacity: 'toggle', 
	//             height: 'toggle'
	//         }, 200);
	// 	},
	// 	hide: function() {
	//         this.animate({
	//             opacity: 'toggle', 
	//             height: 'toggle'
	//         }, 100);
	// 	}
	// });
	// 
	
});


{% if GOOGLE_ANALYTICS %}
_gaq.push(['_trackEvent', "ViewPage", "Backlog", "", 1]);
{% endif %}
</script>
    
{% endblock %}
